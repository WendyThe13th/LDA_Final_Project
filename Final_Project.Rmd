---
title: "Final_Project"
author: "Mengqi Zhu"
date: "2018/11/29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr) 
library(lme4)
library(janitor)
library(corrplot)
library(ggplot2)
library(broom)
library(mice)
```

```{r}
smoke <- read.csv(file = 'frmgham2.csv') %>% 
  clean_names()
```


Figure 1 shows that as individuals age, the likelihood that they are smoking decreases. We can see that when we breaking individuals down by sex, it appears that the overall trend is the same between sexes with males having an overall higher likelihood of being smokers as age increases. 

```{r}

smoke %>%
  ggplot(aes(age, cursmoke)) +
  geom_jitter(height = 0.1) +
  stat_summary(fun.y = mean, geom = "line", col = 'red') +
  ggtitle("Figure 1: Current Smoking Status across Age")


##FIGURE OF INTEREST
smoke %>%
  ggplot(aes(age, cursmoke, group = sex)) +
  geom_jitter(height = 0.1, size = 0.5) +
  stat_summary(fun.y = mean, geom = "line", aes(color=paste("mean", sex))) +
  ggtitle("Figure 2: Current Smoking Status across Age") +
  scale_colour_hue(name = "Sex", labels = c("Male", "Female"))


#longitudinal plot
smoke %>%
  mutate(cursmoke = as.factor(cursmoke),
         sex = as.factor(sex)) %>%
  group_by(period, sex) %>%
  count(cursmoke) %>%
  ggplot(aes(period, n, group = cursmoke, color = cursmoke)) +
  geom_line() +
  facet_wrap(~sex) +
  ggtitle("Figure 3: Current Smoking status across Period by Sex") #period = visit

```

When looking at cigarette packs smoked per day, it appears that the number steadily decreases as individuals get older. The trend once again is the same in each sex however females are smoking less packs a day overall.

```{r}

smoke %>%
  ggplot(aes(age, cigpday)) +
  geom_point() +
  stat_summary(fun.y = mean, geom = "line", size = 1.1, col = 'red') +
  ggtitle("Figure 4: Packs a Day across Age")

smoke %>%
  ggplot(aes(age, cigpday, group = sex)) +
  geom_point(size = 0.75) +
  stat_summary(fun.y = mean, geom = "line", size = 1.1, aes(color=paste("mean", sex))) +
  ggtitle("Figure 5: Cigarettes per Day across Age") +
  scale_colour_hue(name = "Sex", labels = c("Male", "Female")) 
```


In Figure 5, we see that as systolic blood pressure increases the likelihood of smoking decreases. The trend is not as profound in Figure 6 with diastolic BP or with serum total cholesterol in Figure 7. 

```{r}

smoke %>%
  ggplot(aes(sysbp, cursmoke)) +
  geom_jitter(height = 0.1) +
  geom_smooth(color = 'red') +
  ggtitle("Figure 6: Current Smoking Status across Systolic Blood Pressure")

smoke %>%
  ggplot(aes(diabp, cursmoke)) +
  geom_jitter(height = 0.1) +
  geom_smooth(color = 'red') +
  ggtitle("Figure 7: Current Smoking Status across Diastolic Blood Pressure")

smoke %>%
  ggplot(aes(diabp, cursmoke)) +
  geom_jitter(height = 0.1) +
  geom_smooth(color = 'red') +
  ggtitle("Figure 8: Current Smoking Status across Serum Total Cholestserol")
```

#Corrplot 1
It appears that the only significant correlation between the variables of interest is between the two BP measurements and systolic BP and age with a value of 0.39. There is negative correlation between age and smoking status, meaning that the smokers appear to be correlated with youger aged individuals.  

#Corrplot 2
Obvious correlations include BP measurements between bpmeds and prevhyp, age and death, glucose and diabetes, etc. Prevvap was correlated with prevmi and prevchd. Our variable of interest totchol was very highly correlated with ldlc. 

#Corrplot3 
When evaluating the different follow up conditions, most are highly correlated with each other with the exception of hypertension not being correlated with any other condition and stroke only being correlated to cvd at 0.55. BPs are correlated with hypertension

```{r}

#correlation between all interested variables
corr =  smoke %>% 
  dplyr::select(age, cursmoke, sex, sysbp, diabp, totchol) %>%  
  mutate(totchol = as.numeric(totchol)) %>%
  na.omit()

corrplot(cor(corr), method="number",shade.col=NA, tl.col="black", tl.srt=65)


corr2 =  smoke %>% 
  dplyr::select(-randid, -period,  -25:-39) %>%  
  na.omit()

corrplot(cor(corr2), method="number",shade.col=NA, tl.col="black", tl.srt=65)


corr3 =  smoke %>% 
  dplyr::select(25:31) %>%  
  na.omit()

corrplot(cor(corr3), method="number",shade.col=NA, tl.col="black", tl.srt=65)
```



```{r}
#checking missing values (5% rule)
pMiss <- function(x){sum(is.na(x))/length(x)*100}
apply(smoke,2,pMiss) #2 indicates columns
#Remove hdlc, ldlc, glucose, and bpmeds for having more than 5% of missing values.
```


Variable Selection and confounder identidication:

```{r}
smoke.vs = smoke %>% 
  filter(period==1) %>% 
  dplyr::select(c(randid,sex,age,cursmoke,totchol,bmi,heartrte,educ,diabp,sysbp,diabetes,heartrte)) %>% 
  mutate(cursmoke = as.factor(cursmoke)) %>% 
  na.omit()

#(1)
###backward elimination###

back.fit <- glm(cursmoke ~ .-randid, data=smoke.vs,family = 'binomial')
summary(back.fit)
#We then take out the variables with the highest p-value:

step1 <-update(back.fit, . ~ . -sysbp)
summary(step1)

step2 <-update(step1, . ~ . -diabetes)
summary(step2)

#result from backward elimination:
#cursmoke ~ age + sex + totchol + bmi + educ + diabp + heartrte

#only backward elimination is recommeded in case of binary outcome

```

If we change the outcome from cursmoke to cigpday:
```{r}
#(2)
smoke.vs2 = smoke %>% 
  filter(period==1) %>%
  dplyr::select(c(randid,sex,age,cigpday,totchol,bmi,heartrte,educ,diabp,sysbp,diabetes,heartrte)) %>% 
  na.omit()

###backward elimination###

back.fit2 <- lm(cigpday ~ .-randid, data=smoke.vs2)
summary(back.fit2)

step1 <-update(back.fit2, . ~ . -sysbp)
summary(step1)

step2 <-update(step1, . ~ . -diabetes)
summary(step2)
#result from backward elimination:
#full model
#cursmoke ~ age + sex + totchol + bmi + educ + diabp + heartrte
```


```{r}
#Vars with missing values for imputation
smoke2 = smoke %>% 
  dplyr::select(c(cursmoke,bmi,educ,diabp,age,sex,heartrte,totchol,cigpday))
summary(smoke2)
#imputation using predictive mean matching
imputed.smoke <- mice(smoke2,m=5,maxit=50,meth='pmm',seed=500)
#summary(imputed.smoke)

#return to completed dataset
completedData <- complete(imputed.smoke,1)
completedData$randid = smoke$randid
summary(completedData)
```


