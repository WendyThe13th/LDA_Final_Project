---
title: "Final_Project"
author: "Mengqi Zhu"
date: "2018/11/29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr) 
library(lme4)
library(janitor)
library(corrplot)
library(ggplot2)
library(broom)
library(mice)
```

```{r}
smoke <- read.csv(file = 'frmgham2.csv') %>% 
  clean_names()
```


Figure 1 shows that as individuals age, the likelihood that they are smoking decreases. We can see that when we breaking individuals down by sex, it appears that the overall trend is the same between sexes with males having an overall higher likelihood of being smokers as age increases. 

```{r}

smoke %>%
  ggplot(aes(age, cigpday)) +
  geom_jitter(height = 0.1) +
  stat_summary(fun.y = mean, geom = "line", col = 'red') +
  ggtitle("Figure 1: Current Smoking Status across Age")


##FIGURE OF INTEREST
smoke %>%
  ggplot(aes(age, cursmoke, group = sex)) +
  geom_jitter(height = 0.1, size = 0.5) +
  stat_summary(fun.y = mean, geom = "line", aes(color=paste("mean", sex))) +
  ggtitle("Figure 2: Current Smoking Status across Age") +
  scale_colour_hue(name = "Sex", labels = c("Male", "Female"))


#longitudinal plot
smoke %>%
  mutate(cursmoke = as.factor(cursmoke),
         sex = as.factor(sex)) %>%
  group_by(period, sex) %>%
  count(cursmoke) %>%
  ggplot(aes(period, n, group = cursmoke, color = cursmoke)) +
  geom_line() +
  facet_wrap(~sex) +
  ggtitle("Figure 3: Current Smoking status across Period by Sex") #period = visit

```

When looking at cigarette packs smoked per day, it appears that the number steadily decreases as individuals get older. The trend once again is the same in each sex however females are smoking less packs a day overall.

```{r}

smoke %>%
  ggplot(aes(age, cigpday)) +
  geom_point() +
  stat_summary(fun.y = mean, geom = "line", size = 1.1, col = 'red') +
  ggtitle("Figure 4: Packs a Day across Age")

smoke %>%
  ggplot(aes(age, cigpday, group = sex)) +
  geom_point(size = 0.75) +
  stat_summary(fun.y = mean, geom = "line", size = 1.1, aes(color=paste("mean", sex))) +
  ggtitle("Figure 5: Cigarettes per Day across Age") +
  scale_colour_hue(name = "Sex", labels = c("Male", "Female")) 
```


In Figure 5, we see that as systolic blood pressure increases the likelihood of smoking decreases. The trend is not as profound in Figure 6 with diastolic BP or with serum total cholesterol in Figure 7. 

```{r}

smoke %>%
  ggplot(aes(sysbp, cursmoke)) +
  geom_jitter(height = 0.1) +
  geom_smooth(color = 'red') +
  ggtitle("Figure 6: Current Smoking Status across Systolic Blood Pressure")

smoke %>%
  ggplot(aes(diabp, cursmoke)) +
  geom_jitter(height = 0.1) +
  geom_smooth(color = 'red') +
  ggtitle("Figure 7: Current Smoking Status across Diastolic Blood Pressure")

smoke %>%
  ggplot(aes(diabp, cursmoke)) +
  geom_jitter(height = 0.1) +
  geom_smooth(color = 'red') +
  ggtitle("Figure 8: Current Smoking Status across Serum Total Cholestserol")
```

#Corrplot 1
It appears that the only significant correlation between the variables of interest is between the two BP measurements and systolic BP and age with a value of 0.39. There is negative correlation between age and smoking status, meaning that the smokers appear to be correlated with youger aged individuals.  

#Corrplot 2
Obvious correlations include BP measurements between bpmeds and prevhyp, age and death, glucose and diabetes, etc. Prevvap was correlated with prevmi and prevchd. Our variable of interest totchol was very highly correlated with ldlc. 

#Corrplot3 
When evaluating the different follow up conditions, most are highly correlated with each other with the exception of hypertension not being correlated with any other condition and stroke only being correlated to cvd at 0.55. BPs are correlated with hypertension

```{r}

#correlation between all interested variables
corr =  smoke %>% 
  dplyr::select(age, cursmoke, sex, sysbp, diabp, totchol) %>%  
  mutate(totchol = as.numeric(totchol)) %>%
  na.omit()

corrplot(cor(corr), method="number",shade.col=NA, tl.col="black", tl.srt=65)


corr2 =  smoke %>% 
  dplyr::select(-randid, -period,  -25:-39) %>%  
  na.omit()

corrplot(cor(corr2), method="number",shade.col=NA, tl.col="black", tl.srt=65)


corr3 =  smoke %>% 
  dplyr::select(25:31) %>%  
  na.omit()

corrplot(cor(corr3), method="number",shade.col=NA, tl.col="black", tl.srt=65)
```



```{r}
#checking missing values (5% rule)
pMiss <- function(x){sum(is.na(x))/length(x)*100}
apply(smoke,2,pMiss) #2 indicates columns
#Remove hdlc, ldlc, glucose, and bpmeds for having more than 5% of missing values.
```
It is okay as hdlc, ldlc are highly correlated with totchol, glucose is highy correlated with diabetes, bmmeds is highly correlated with sysbp and diabp. Therefore it won't lose much information to just drop these features.
```{r}
smoke_na_omit = smoke %>%
  select(-hdlc,-ldlc,-glucose,-bpmeds) %>%
  na.omit()
```

Variable Selection and confounder identidication:
# Question 1
Residual plots for finding confounders between cursmoke and age
```{r}
#cursmoke vs age
smoke_na_omit %>%
  ggplot(aes(x = age, y = cursmoke))+
  geom_jitter(height = 0.1) +
  geom_point(size=0.1) +
  geom_smooth(method = 'loess') +
ggtitle('cursmoke vs age, Scatterplot')+ 
  theme( plot.title = element_text(hjust = 0.5))
```

```{r}
#adjust sex
cursmoke_adj_sex <- glm(cursmoke~sex, data = smoke_na_omit,family='binomial')$residuals
age_adj_sex <- lm(age~sex, data = smoke_na_omit)$residuals
adj_res_sex <- tibble(id=smoke_na_omit$randid, cursmoke_adj_sex=cursmoke_adj_sex, age_adj_sex=age_adj_sex)

adj_res_sex %>%
ggplot(aes(x=age_adj_sex, y=cursmoke_adj_sex))+
geom_point(size=0.75)  +
geom_smooth(method = 'loess') +
  
ggtitle("cursmoke vs age, sex adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust totchol

cursmoke_adj_totchol <- glm(cursmoke~totchol, data = smoke_na_omit,family = "binomial")$residuals
age_adj_totchol <- lm(age~totchol, data = smoke_na_omit)$residuals
adj_res_totchol <- tibble(id=smoke_na_omit$randid, cursmoke_adj_totchol=cursmoke_adj_totchol, age_adj_totchol=age_adj_totchol)

adj_res_totchol %>%
ggplot(aes(x=age_adj_totchol, y=cursmoke_adj_totchol))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cursmoke vs age, totchol adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust sysbp
cursmoke_adj_sysbp <- glm(cursmoke~sysbp, data = smoke_na_omit,family = "binomial")$residuals
age_adj_sysbp <- lm(age~sysbp, data = smoke_na_omit)$residuals
adj_res_sysbp <- tibble(id=smoke_na_omit$randid, cursmoke_adj_sysbp=cursmoke_adj_sysbp, age_adj_sysbp=age_adj_sysbp)

adj_res_sysbp %>%
ggplot(aes(x=age_adj_sysbp, y=cursmoke_adj_sysbp))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cursmoke vs age, sysbp adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust diabp
cursmoke_adj_diabp <- glm(cursmoke~diabp, data = smoke_na_omit,family = "binomial")$residuals
age_adj_diabp <- lm(age~diabp, data = smoke_na_omit)$residuals
adj_res_diabp <- tibble(id=smoke_na_omit$randid, cursmoke_adj_diabp=cursmoke_adj_diabp, age_adj_sysbp=age_adj_diabp)

adj_res_diabp %>%
ggplot(aes(x=age_adj_diabp, y=cursmoke_adj_diabp))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cursmoke vs age, diabp adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust bmi
cursmoke_adj_bmi <- glm(cursmoke~bmi, data = smoke_na_omit,family = "binomial")$residuals
age_adj_bmi <- lm(age~bmi, data = smoke_na_omit)$residuals
adj_res_bmi <- tibble(id=smoke_na_omit$randid, cursmoke_adj_bmi=cursmoke_adj_bmi, age_adj_bmi=age_adj_bmi)

adj_res_bmi %>%
ggplot(aes(x=age_adj_bmi, y=cursmoke_adj_bmi))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cursmoke vs age, bmi adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust heartrte
cursmoke_adj_heartrte <- glm(cursmoke~heartrte, data = smoke_na_omit,family = "binomial")$residuals
age_adj_heartrte <- lm(age~heartrte, data = smoke_na_omit)$residuals
adj_res_heartrte <- tibble(id=smoke_na_omit$randid, cursmoke_adj_heartrte=cursmoke_adj_heartrte, age_adj_heartrte=age_adj_heartrte)

adj_res_heartrte %>%
ggplot(aes(x=age_adj_heartrte, y=cursmoke_adj_heartrte))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cursmoke vs age, heartrte adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust educ
cursmoke_adj_educ <- glm(cursmoke~educ, data = smoke_na_omit,family = "binomial")$residuals
age_adj_educ <- lm(age~educ, data = smoke_na_omit)$residuals
adj_res_educ <- tibble(id=smoke_na_omit$randid, cursmoke_adj_educ=cursmoke_adj_educ, age_adj_educ=age_adj_educ)

adj_res_educ %>%
ggplot(aes(x=age_adj_educ, y=cursmoke_adj_educ))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cursmoke vs age, educ adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust diabetes
cursmoke_adj_diabetes <- glm(cursmoke~diabetes, data = smoke_na_omit,family = "binomial")$residuals
age_adj_diabetes <- lm(age~diabetes, data = smoke_na_omit)$residuals
adj_res_diabetes <- tibble(id=smoke_na_omit$randid, cursmoke_adj_diabetes=cursmoke_adj_diabetes, age_adj_diabetes=age_adj_diabetes)

adj_res_diabetes %>%
ggplot(aes(x=age_adj_diabetes, y=cursmoke_adj_diabetes))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cursmoke vs age, diabetes adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

Using backward:
```{r}
smoke.vs = smoke %>% 
  filter(period==1) %>% 
  dplyr::select(c(randid,sex,age,cursmoke,totchol,bmi,heartrte,educ,diabp,sysbp,diabetes,heartrte)) %>% 
  mutate(cursmoke = as.factor(cursmoke)) %>% 
  na.omit()

#(1)
###backward elimination###

back.fit <- glm(cursmoke ~ .-randid, data=smoke.vs,family = 'binomial')
summary(back.fit)
#We then take out the variables with the highest p-value:

step1 <-update(back.fit, . ~ . -sysbp)
summary(step1)

step2 <-update(step1, . ~ . -diabetes)
summary(step2)

#result from backward elimination:
#cursmoke ~ age + sex + totchol + bmi + educ + diabp + heartrte

#only backward elimination is recommeded in case of binary outcome

```



#Question 2


Variable Selection and confounder identidication:

Residual plots for finding confounders between number of cigarettes smoked per day and age
```{r}
#cigpday vs age
smoke_na_omit %>%
  ggplot(aes(x = age, y = cigpday))+
  geom_jitter(height = 0.1) +
  geom_point(size=0.1) +
  geom_smooth(method = 'loess') +
ggtitle('cigpday vs age, Scatterplot')+ 
  theme( plot.title = element_text(hjust = 0.5))
```

```{r}
#adjust sex
cigpday_adj_sex <- lm(cigpday~sex, data = smoke_na_omit)$residuals
age_adj_sex <- lm(age~sex, data = smoke_na_omit)$residuals
adj_res_sex <- tibble(id=smoke_na_omit$randid, cigpday_adj_sex=cigpday_adj_sex, age_adj_sex=age_adj_sex)

adj_res_sex %>%
ggplot(aes(x=age_adj_sex, y=cigpday_adj_sex))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, sex adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust totchol

cigpday_adj_totchol <- lm(cigpday~totchol, data = smoke_na_omit)$residuals
age_adj_totchol <- lm(age~totchol, data = smoke_na_omit)$residuals
adj_res_totchol <- tibble(id=smoke_na_omit$randid, cigpday_adj_totchol=cigpday_adj_totchol, age_adj_totchol=age_adj_totchol)

adj_res_totchol %>%
ggplot(aes(x=age_adj_totchol, y=cigpday_adj_totchol))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, totchol adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust sysbp
cigpday_adj_sysbp <- lm(cigpday~sysbp, data = smoke_na_omit)$residuals
age_adj_sysbp <- lm(age~sysbp, data = smoke_na_omit)$residuals
adj_res_sysbp <- tibble(id=smoke_na_omit$randid, cigpday_adj_sysbp=cigpday_adj_sysbp, age_adj_sysbp=age_adj_sysbp)

adj_res_sysbp %>%
ggplot(aes(x=age_adj_sysbp, y=cigpday_adj_sysbp))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, sysbp adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust diabp
cigpday_adj_diabp <- lm(cigpday~diabp, data = smoke_na_omit)$residuals
age_adj_diabp <- lm(age~diabp, data = smoke_na_omit)$residuals
adj_res_diabp <- tibble(id=smoke_na_omit$randid, cigpday_adj_diabp=cigpday_adj_diabp, age_adj_sysbp=age_adj_diabp)

adj_res_diabp %>%
ggplot(aes(x=age_adj_diabp, y=cigpday_adj_diabp))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, diabp adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust bmi
cigpday_adj_bmi <- lm(cigpday~bmi, data = smoke_na_omit)$residuals
age_adj_bmi <- lm(age~bmi, data = smoke_na_omit)$residuals
adj_res_bmi <- tibble(id=smoke_na_omit$randid, cigpday_adj_bmi=cigpday_adj_bmi, age_adj_bmi=age_adj_bmi)

adj_res_bmi %>%
ggplot(aes(x=age_adj_bmi, y=cigpday_adj_bmi))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, bmi adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust heartrte
cigpday_adj_heartrte <- lm(cigpday~heartrte, data = smoke_na_omit)$residuals
age_adj_heartrte <- lm(age~heartrte, data = smoke_na_omit)$residuals
adj_res_heartrte <- tibble(id=smoke_na_omit$randid, cigpday_adj_heartrte=cigpday_adj_heartrte, age_adj_heartrte=age_adj_heartrte)

adj_res_heartrte %>%
ggplot(aes(x=age_adj_heartrte, y=cigpday_adj_heartrte))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, heartrte adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust educ
cigpday_adj_educ <- lm(cigpday~educ, data = smoke_na_omit)$residuals
age_adj_educ <- lm(age~educ, data = smoke_na_omit)$residuals
adj_res_educ <- tibble(id=smoke_na_omit$randid, cigpday_adj_educ=cigpday_adj_educ, age_adj_educ=age_adj_educ)

adj_res_educ %>%
ggplot(aes(x=age_adj_educ, y=cigpday_adj_educ))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, educ adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
#adjust diabetes
cigpday_adj_diabetes <- lm(cigpday~diabetes, data = smoke_na_omit)$residuals
age_adj_diabetes <- lm(age~diabetes, data = smoke_na_omit)$residuals
adj_res_diabetes <- tibble(id=smoke_na_omit$randid, cigpday_adj_diabetes=cigpday_adj_diabetes, age_adj_diabetes=age_adj_diabetes)

adj_res_diabetes %>%
ggplot(aes(x=age_adj_diabetes, y=cigpday_adj_diabetes))+
geom_point(size=0.75) +
geom_smooth(method = 'loess') +
ggtitle("cigpday vs age, diabetes adjusted")+ 
  theme(plot.title = element_text(hjust = 0.5))

```


```{r}
#(2)
smoke.vs2 = smoke %>% 
  filter(period==1) %>%
  dplyr::select(c(randid,sex,age,cigpday,totchol,bmi,heartrte,educ,diabp,sysbp,diabetes,heartrte)) %>% 
  na.omit()

###backward elimination###

back.fit2 <- lm(cigpday ~ .-randid, data=smoke.vs2)
summary(back.fit2)

step1 <-update(back.fit2, . ~ . -sysbp)
summary(step1)

step2 <-update(step1, . ~ . -diabetes)
summary(step2)
#result from backward elimination:
#full model
#cigpday ~ age + sex + totchol + bmi + educ + diabp + heartrte
```

#Question 3

#Question 4

#QUestion 5



```{r}
#Vars with missing values for imputation
smoke2 = smoke %>% 
  dplyr::select(c(cursmoke,bmi,educ,diabp,age,sex,heartrte,totchol,cigpday))
summary(smoke2)
#imputation using predictive mean matching
imputed.smoke <- mice(smoke2,m=5,maxit=50,meth='pmm',seed=500)
#summary(imputed.smoke)

#return to completed dataset
completedData <- complete(imputed.smoke,1)
completedData$randid = smoke$randid
summary(completedData)
```


